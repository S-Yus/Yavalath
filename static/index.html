<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yavalathï¼ˆ4ã§å‹ã¡ï¼3ã§è² ã‘ï¼‰ğŸ²</title>
<style>
/* ---------- Theme ---------- */
:root{
  --bg-wood1:#a46d3c; --bg-wood2:#c28957; --bg-wood3:#8e5c33;
  --panel:#0f1222cf; --panel-border:#6dd6ff40;
  --grid:#2c3149; --grid2:#101425;
  --p1:#ffd84d; --p1-hi:#fff7bf;
  --p2:#f5f7fb; --p2-hi:#ffffff;
  --hint:#35d1ff6b; --win:#ff4d7a; --accent:#6dd6ff;
  --text:#eef3ff; --muted:#b7c1da;
}

/* æœ¨ç›®èƒŒæ™¯ï¼ˆç”»åƒãªã—ã§è¡¨ç¾ï¼‰ */
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family: ui-rounded, "SF Pro Rounded", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background:
    repeating-linear-gradient(90deg, #0000 0 10px, #00000008 10px 11px),
    linear-gradient(180deg, var(--bg-wood1), var(--bg-wood2) 60%, var(--bg-wood3));
}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.app{min-height:100%; display:flex; flex-direction:column; gap:14px; }
.header{
  margin:16px auto 0; padding:12px 16px;
  backdrop-filter: blur(6px);
  background: var(--panel);
  border: 1px solid var(--panel-border);
  box-shadow: 0 20px 40px #00000055, inset 0 0 40px #ffffff05;
  border-radius: 16px;
  width:min(980px, 92vw);
}
.title{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.title h1{font-size:22px; margin:0}
.badge{
  font-weight:700; padding:4px 10px; border-radius:999px;
  color:#07121a; background:linear-gradient(180deg,#b0eeff,#6dd6ff);
  box-shadow: 0 4px 10px #00000040, inset 0 -2px 4px #ffffffaa;
}

.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
button{
  --glow:#7bf3ff;
  appearance:none; border:none; cursor:pointer;
  color:#0b1421; font-weight:700; letter-spacing:.02em;
  background:linear-gradient(180deg,#fff,#eaf6ff);
  padding:8px 14px; border-radius:12px;
  box-shadow: 0 8px 20px #0000004a, inset 0 -2px 6px #0002, 0 0 0 0 #7bf3ff00;
  border:1px solid #ffffff88;
  transition: transform .06s ease, box-shadow .3s ease;
}
button:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px #00000050, 0 0 24px 0 var(--glow);}
button:active{ transform: translateY(1px);}
label { color:var(--muted); user-select:none; }
#status{ margin-top:6px; font-weight:800; }

/* ç›¤ */
.board-wrap{ display:grid; place-items:center; width:100%; }
.stage{
  width:min(92vmin, 780px); aspect-ratio:1;
  margin:8px auto 18px;
  position:relative;
  filter: drop-shadow(0 22px 30px #00000066);
}

/* ãƒ©ã‚°ï¼ˆæ•·ç‰©ï¼‰ã¨ãƒœãƒ¼ãƒ‰æ  */
.rug{
  position:absolute; inset:-18px; border-radius:30px;
  background: radial-gradient(120% 120% at 20% 20%, #00000033, #0000 60%),
              conic-gradient(from 10deg, #2b334d, #22283f, #20263d, #26304c);
  box-shadow: inset 0 0 0 1px #ffffff0f, inset 0 0 40px #00000088;
}
.board-frame{
  position:absolute; inset:0; border-radius:22px;
  background: linear-gradient(180deg,#101425,#0a0e1f);
  box-shadow: inset 0 1px 0 #ffffff1a, inset 0 -40px 80px #000000cc, 0 0 0 3px #ffffff14;
}

/* SVGãƒœãƒ¼ãƒ‰ */
#board{ position:absolute; inset:24px; width:calc(100% - 48px); height:calc(100% - 48px); }
.grid-plate{
  fill:url(#gridGrad);
  stroke:#0000; rx:22; ry:22;
}

/* ã‚»ãƒ«ãƒ»ã‚¹ãƒˆãƒ¼ãƒ³ */
.hex{ fill:#0d1124; stroke: #2f3759; stroke-width:1.3; cursor:pointer; }
.hex:hover{ filter:brightness(1.15); }
.stone{ pointer-events:none; filter:url(#shadowStone); }
.stone.p1{ fill:url(#gradP1); }
.stone.p2{ fill:url(#gradP2); }
.stone.pop{ animation: pop .22s ease both; }
@keyframes pop{ from{ transform:scale(.2); opacity:0 } to { transform:scale(1); opacity:1 } }

/* ãƒ’ãƒ³ãƒˆ */
.hint{ fill:var(--hint); stroke:none; }

/* å‹ã¡ãƒ©ã‚¤ãƒ³ */
.win-line{ stroke:var(--win); stroke-width:7; stroke-linecap:round; filter:url(#glowWin); }

/* ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ */
.confetti{
  position:absolute; inset:0; pointer-events:none; overflow:hidden;
}
.confetti span{
  position:absolute; top:-10px; width:8px; height:14px; border-radius:2px;
  animation: fall linear forwards;
}
@keyframes fall{
  to { transform: translateY(110% ) rotate(720deg); opacity: .9; }
}

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer{ color:#ecf4ff; text-shadow:0 2px 2px #0008; width:min(980px,92vw); margin:0 auto 18px; }
.small{ color:var(--muted); font-size:.92rem }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>Yavalathï¼ˆ4ã§å‹ã¡ï¼3ã§è² ã‘ï¼‰</h1>
      <span id="turnBadge" class="badge">æ‰‹ç•ªï¼šé»„ğŸŸ¡</span>
    </div>
    <div class="controls">
      <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="undoBtn">â†©ï¸ Undo</button>
      <label><input type="checkbox" id="hintToggle"> ãƒªãƒ¼ãƒå€™è£œã‚’ç‚¹ç¯</label>
    </div>
    <div id="status" class="small"></div>
  </div>

  <div class="board-wrap">
    <div class="stage">
      <div class="rug"></div>
      <div class="board-frame"></div>
      <svg id="board" viewBox="-400 -400 800 800" aria-label="board">
        <defs>
          <!-- ç›¤ã®å¾®å¦™ãªæ¨¡æ§˜ -->
          <linearGradient id="gridGrad" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#0b1024"/>
            <stop offset="1" stop-color="#0d1431"/>
          </linearGradient>
          <!-- ã‚¹ãƒˆãƒ¼ãƒ³å…‰æ²¢ -->
          <radialGradient id="gradP1" cx="30%" cy="28%" r="80%">
            <stop offset="0" stop-color="#fff6c8"/>
            <stop offset=".45" stop-color="#ffd84d"/>
            <stop offset="1" stop-color="#eab21e"/>
          </radialGradient>
          <radialGradient id="gradP2" cx="30%" cy="28%" r="80%">
            <stop offset="0" stop-color="#ffffff"/>
            <stop offset=".55" stop-color="#f2f6ff"/>
            <stop offset="1" stop-color="#cfd7e6"/>
          </radialGradient>
          <!-- å½±ãƒ»å…‰å½© -->
          <filter id="shadowStone" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000" flood-opacity=".6"/>
          </filter>
          <filter id="glowWin" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2.2" result="b"/>
            <feMerge>
              <feMergeNode in="b"/><feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <rect class="grid-plate" x="-360" y="-360" width="720" height="720" rx="24" ry="24"></rect>
        <g id="layer-grid"></g>
        <g id="layer-hints"></g>
        <g id="layer-stones"></g>
        <g id="layer-effects"></g>
      </svg>
      <div id="confetti" class="confetti"></div>
    </div>
  </div>

  <div class="footer">
    <p class="small">ãƒ«ãƒ¼ãƒ«ï¼šäº¤äº’ã«è‡ªåˆ†ã®çŸ³ã‚’ç½®ãã€‚<b>4 é€£</b>ã§å‹ã¡ã€‚ãŸã ã—<b>4 ãŒç„¡ã„çŠ¶æ…‹ã§ 3 é€£</b>ã‚’ä½œã‚‹ã¨ãã®ç¬é–“ã«è² ã‘ã€‚
      4 ã¨ 3 ãŒåŒæ™‚ã«ã§ããŸå ´åˆã¯ <b>å‹ã¡ãŒå„ªå…ˆ</b>ã€‚</p>
  </div>
</div>

<script>
/*** ç›¤ã¨ãƒ«ãƒ¼ãƒ«ï¼ˆå‰å›ç‰ˆã‚’ãƒ™ãƒ¼ã‚¹ã«æ¼”å‡ºã‚’è¿½åŠ ï¼‰ ***/
const RADIUS=5, HEX_SIZE=28;
const DIRS=[[+1,0],[+1,-1],[0,-1],[-1,0],[-1,+1],[0,+1]];
const keyOf=(q,r)=>`${q},${r}`;
const axialToPixel=(q,r)=>({ x: HEX_SIZE*(Math.sqrt(3)*q + Math.sqrt(3)/2*r),
                              y: HEX_SIZE*(3/2*r) });
const hexPolygonPoints=(x,y,size)=>{
  const pts=[];
  for(let i=0;i<6;i++){ const a=(60*i-30)*Math.PI/180;
    pts.push([x+size*Math.cos(a), y+size*Math.sin(a)]);
  }
  return pts.map(p=>p.join(",")).join(" ");
};

const state={cells:new Map(),turn:1,history:[],gameOver:false,lastPlaced:null,winLine:null};
const boardEl=document.getElementById("board");
const gGrid=document.getElementById("layer-grid");
const gHints=document.getElementById("layer-hints");
const gStones=document.getElementById("layer-stones");
const gFx=document.getElementById("layer-effects");
const statusEl=document.getElementById("status");
const badgeEl=document.getElementById("turnBadge");
const hintToggle=document.getElementById("hintToggle");
const confettiEl=document.getElementById("confetti");

function setBadge(){
  badgeEl.textContent=`æ‰‹ç•ªï¼š${state.turn===1?"é»„ğŸŸ¡":"ç™½âšªï¸"}`;
  badgeEl.style.background = state.turn===1
    ? "linear-gradient(180deg,#fff2a8,#ffd84d)"
    : "linear-gradient(180deg,#ffffff,#dfe8ff)";
}

function setStatus(msg){
  if(msg){statusEl.textContent=msg; return;}
  statusEl.textContent = state.gameOver? "ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº†" : "ãƒ’ãƒ³ãƒˆï¼šã€1ãƒã‚¹ç©ºãï¼‹2é€£ã€ãŒç‹™ã„ç›®";
}

function generateBoard(){
  gGrid.innerHTML=gHints.innerHTML=gStones.innerHTML=gFx.innerHTML="";
  state.cells.clear(); state.turn=1; state.history=[]; state.gameOver=false; state.winLine=null;
  // ã‚»ãƒ«ç”Ÿæˆï¼ˆæ­£å…­è§’å½¢é ˜åŸŸï¼‰
  for(let q=-RADIUS+1;q<=RADIUS-1;q++){
    const r1=Math.max(-RADIUS+1,-q-RADIUS+1);
    const r2=Math.min(RADIUS-1,-q+RADIUS-1);
    for(let r=r1;r<=r2;r++){
      const {x,y}=axialToPixel(q,r); const k=keyOf(q,r);
      const hex=document.createElementNS("http://www.w3.org/2000/svg","polygon");
      hex.setAttribute("points",hexPolygonPoints(x,y,HEX_SIZE*0.98));
      hex.classList.add("hex"); hex.dataset.key=k; hex.addEventListener("click",onPlace);
      gGrid.appendChild(hex);
      const stone=document.createElementNS("http://www.w3.org/2000/svg","circle");
      stone.setAttribute("cx",x); stone.setAttribute("cy",y);
      stone.setAttribute("r",HEX_SIZE*0.56); stone.setAttribute("opacity","0");
      stone.classList.add("stone"); stone.dataset.key=k; gStones.appendChild(stone);
      state.cells.set(k,{q,r,x,y,stone:0,stoneEl:stone,hexEl:hex,hintEl:null});
    }
  }
  setBadge(); setStatus(); refreshHints();
}
function onPlace(e){
  if(state.gameOver) return;
  const k=e.currentTarget.dataset.key, c=state.cells.get(k);
  if(!c || c.stone!==0) return;

  placeStone(k,state.turn,true);
  const result=evaluateAfterMove(c.q,c.r,state.turn);
  if(result.win){
    drawWinLine(result.line);
    state.gameOver=true; setStatus("ğŸ¯ 4é€£ã§å‹ã¡ï¼");
    fireConfetti();
  }else if(result.lose){
    state.gameOver=true; setStatus("ğŸ’¥ 3é€£ã‚’ä½œã£ã¦ã—ã¾ã„è² ã‘â€¦");
  }else{
    state.turn=3-state.turn; setBadge(); setStatus(); if(hintToggle.checked) refreshHints();
  }
}
function placeStone(k,player,animate=false){
  const c=state.cells.get(k);
  c.stone=player; c.stoneEl.setAttribute("opacity","1");
  c.stoneEl.classList.toggle("p1",player===1);
  c.stoneEl.classList.toggle("p2",player===2);
  if(animate){ c.stoneEl.classList.remove("pop"); void c.stoneEl.offsetWidth; c.stoneEl.classList.add("pop"); }
  state.history.push({key:k}); state.lastPlaced=k;
}
function undo(){
  if(state.history.length===0) return;
  const last=state.history.pop();
  const c=state.cells.get(last.key);
  c.stone=0; c.stoneEl.setAttribute("opacity","0");
  if(state.winLine){ state.winLine.remove(); state.winLine=null; }
  state.gameOver=false; state.turn=3-state.turn; setBadge(); setStatus(); refreshHints();
}
document.getElementById("resetBtn").addEventListener("click",generateBoard);
document.getElementById("undoBtn").addEventListener("click",undo);
hintToggle.addEventListener("change",()=>refreshHints());

/* åˆ¤å®š */
function evaluateAfterMove(q,r,player){
  let win=false, lose=false, winLine=null;
  for(let i=0;i<3;i++){
    const [dq1,dr1]=DIRS[i], [dq2,dr2]=DIRS[i+3];
    const L1=countDir(q,r,dq1,dr1,player), L2=countDir(q,r,dq2,dr2,player);
    const total=1+L1+L2;
    if(total>=4){ win=true;
      const s=axialToPixel(q-dq1*L1, r-dr1*L1), e=axialToPixel(q+dq2*L2, r+dr2*L2);
      winLine=[s,e];
    }else if(total===3){ lose=true; }
  }
  return {win, lose:(!win&&lose), line:winLine};
}
function countDir(q,r,dq,dr,player){
  let n=0; while(true){ q+=dq; r+=dr;
    const c=state.cells.get(keyOf(q,r)); if(c && c.stone===player) n++; else break; }
  return n;
}
function drawWinLine(line){
  const L=document.createElementNS("http://www.w3.org/2000/svg","line");
  L.setAttribute("x1",line[0].x); L.setAttribute("y1",line[0].y);
  L.setAttribute("x2",line[1].x); L.setAttribute("y2",line[1].y);
  L.classList.add("win-line"); gFx.appendChild(L); state.winLine=L;
}

/* ãƒ’ãƒ³ãƒˆï¼ˆç°¡æ˜“ 1ç©º+2ï¼‰ */
function refreshHints(){
  state.cells.forEach(c=>{ if(c.hintEl){c.hintEl.remove(); c.hintEl=null;} });
  if(!hintToggle.checked || state.gameOver) return;
  const me=state.turn;
  state.cells.forEach(c=>{
    if(c.stone!==0) return;
    c.stone=me;
    let makes3=false, oneGapTwo=false;
    for(let i=0;i<3;i++){
      const [aq,ar]=DIRS[i],[bq,br]=DIRS[i+3];
      const L1=countDir(c.q,c.r,aq,ar,me), L2=countDir(c.q,c.r,bq,br,me);
      const tot=1+L1+L2; if(tot===3) makes3=true;
      if((L1>=2&&L2>=1)||(L2>=2&&L1>=1)) oneGapTwo=true;
    }
    c.stone=0;
    if(!makes3 && oneGapTwo){
      const h=document.createElementNS("http://www.w3.org/2000/svg","circle");
      h.setAttribute("cx",c.x); h.setAttribute("cy",c.y); h.setAttribute("r",HEX_SIZE*0.34);
      h.classList.add("hint"); gHints.appendChild(h); c.hintEl=h;
    }
  });
}

/* å‹åˆ©æ¼”å‡ºï¼šã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ */
function fireConfetti(){
  confettiEl.innerHTML="";
  const colors=["#ff6b6b","#ffd93d","#6dd6ff","#b28dff","#8aff80","#ff9fde"];
  const N=80;
  for(let i=0;i<N;i++){
    const s=document.createElement("span");
    const size=6+Math.random()*8;
    s.style.left = (Math.random()*100)+"%";
    s.style.width = size+"px"; s.style.height = (size*1.5)+"px";
    s.style.background = colors[(Math.random()*colors.length)|0];
    s.style.opacity = .85;
    s.style.animationDuration = (1.8 + Math.random()*1.2) + "s";
    s.style.animationDelay = (Math.random()*0.2) + "s";
    s.style.transform = `translateY(${(-10-Math.random()*40)}%) rotate(${Math.random()*360}deg)`;
    confettiEl.appendChild(s);
  }
  setTimeout(()=>confettiEl.innerHTML="", 3200);
}

/* èµ·å‹• */
generateBoard();
</script>
</body>
</html>
